version: '3.8'

services:
  # ==========================================
  # PostgreSQL Database - ULTRA LÉGER
  # ==========================================
  postgres:
    image: postgres:15-alpine
    container_name: prepadata_postgres
    environment:
      POSTGRES_USER: prepadata
      POSTGRES_PASSWORD: prepadata_pwd
      POSTGRES_DB: analytics
    volumes:
      - ./sql:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prepadata -d analytics"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ==========================================
  # Apache Airflow - VERSION OFFICIELLE
  # ==========================================
  airflow-init:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: airflow_init
    depends_on:
      - postgres
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/analytics
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: >
      bash -c "
      echo '=== ATTENTE POSTGRESQL ===' &&
      until PGPASSWORD=prepadata_pwd psql -h postgres -U prepadata -d analytics -c 'SELECT 1' >/dev/null 2>&1; do
        echo 'En attente de PostgreSQL...';
        sleep 2;
      done &&
      echo '=== INITIALISATION DB ===' &&
      airflow db init &&
      echo '=== UPGRADE DB ===' &&
      airflow db upgrade &&
      echo '=== CREATION UTILISATEUR ===' &&
      airflow users create \
        --username admin \
        --password admin \
        --firstname Admin \
        --lastname User \
        --role Admin \
        --email admin@example.com || echo 'Utilisateur existe déjà'
      "

  airflow-webserver:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: prepadata_airflow_webserver
    restart: unless-stopped
    depends_on:
      - postgres
      - airflow-init
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/analytics
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
      AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX: "True"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    ports:
      - "8080:8080"
    command: >
      bash -c "
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --no-cache-dir scikit-learn==1.3.0 pandas numpy && 
      sleep 5 &&
      echo '=== DEMARRAGE WEBSERVER ===' &&
      airflow webserver --port 8080
      "

  airflow-scheduler:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: prepadata_airflow_scheduler
    restart: unless-stopped
    depends_on:
      - airflow-webserver
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/analytics
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: >
      bash -c "
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --no-cache-dir scikit-learn==1.3.0 pandas numpy && 
      sleep 10 &&
      echo '=== DEMARRAGE SCHEDULER ===' &&
      airflow scheduler
      "

  prepadata:
    image: python:3.10-slim
    container_name: prepadata_service
    depends_on:
      - postgres
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: analytics
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
    volumes:
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
      - ./microservices/prepa-data/requirements.txt:/opt/prepadata/requirements.txt
    command: >
      bash -c "
      pip install --no-cache-dir pandas numpy scikit-learn sqlalchemy psycopg2-binary &&
      echo 'PrepData Microservice ready!' &&
      tail -f /dev/null
      "