version: '3.8'

services:
  # ==========================================
  # DATABASES & MESSAGE BROKER
  # ==========================================
  postgres:
    image: postgres:13
    container_name: postgres
    environment:
      POSTGRES_USER: prepadata
      POSTGRES_PASSWORD: prepadata_pwd
      POSTGRES_DB: prepadata_db
      POSTGRES_MULTIPLE_DATABASES: "profiler_db,predictor_db"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_new:/var/lib/postgresql/data
      - ./init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U prepadata"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 30s
      retries: 3
  

  # ==========================================
  # MLFLOW & MINIO
  # ==========================================
  minio:
    image: minio/minio
    container_name: minio
    ports:
      - "9001:9000"
      - "9002:9001"
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data 

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.7.1
    container_name: mlflow
    ports:
      - "5001:5000"
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minioadmin
      AWS_SECRET_ACCESS_KEY: minioadmin
    depends_on:
      - minio
      - postgres
    command: >
      mlflow server
      --backend-store-uri postgresql://prepadata:prepadata_pwd@postgres:5432/mlflow_db
      --default-artifact-root s3://mlflow/
      --host 0.0.0.0

  # ==========================================
  # ELASTICSEARCH (For Data Indexing)
  # ==========================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.10
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

  # ==========================================
  # AIRFLOW (Orchestrator)
  # ==========================================
  airflow-init:
    image: apache/airflow:2.7.3
    depends_on:
      - postgres
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      _AIRFLOW_DB_UPGRADE: "true"
      _AIRFLOW_WWW_USER_CREATE: "true"
      _AIRFLOW_WWW_USER_USERNAME: "admin"
      _AIRFLOW_WWW_USER_PASSWORD: "admin"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: version

  airflow-webserver:
    image: apache/airflow:2.7.3
    restart: unless-stopped
    depends_on:
      - postgres
      - airflow-init
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
      AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX: "True"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    ports:
      - "8081:8080"
    command: >
      bash -c "
      echo '=== UPGRADE PIP ===' &&
      pip install --upgrade pip &&
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir scikit-learn>=1.6.1 pandas numpy && 
      sleep 5 &&
      echo '=== DEMARRAGE WEBSERVER ===' &&
      airflow webserver --port 8080
      "

  airflow-scheduler:
    image: apache/airflow:2.7.3
    restart: unless-stopped
    depends_on:
      - airflow-webserver
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: >
      bash -c "
      echo '=== UPGRADE PIP ===' &&
      pip install --upgrade pip &&
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir scikit-learn>=1.6.1 pandas numpy && 
      sleep 10 &&
      echo '=== DEMARRAGE SCHEDULER ===' &&
      airflow scheduler
      "

  # ==========================================
  # MICROSERVICES
  # ==========================================

  eureka-server:
    build: 
      context: ./microservices/eureka-server
    image: edupath/eureka-server:latest
    ports:
      - "8761:8761"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  api-gateway:
    build:
      context: ./microservices/api-gateway
      dockerfile: Dockerfile
    image: edupath/api-gateway:latest
    depends_on:
      - lms-connector
      - student-profiler
      - path-predictor
      - reco-builder
      - teacher-console-api
      - student-coach-api
      - eureka-server
    environment:
      - PROFILER_URL=http://student-profiler:8000
      - RECCO_URL=http://reco-builder:8003
      - COACH_API_URL=http://student-coach-api:8005
      - EUREKA_HOST=eureka-server
      - EUREKA_PORT=8761
      - INSTANCE_HOST=api-gateway
      - INSTANCE_PORT=4000
    ports:
      - "4000:4000"

  prepadata:
    build:
      context: ./microservices/prepa-data
    image: edupath/prepa-data:latest
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: prepadata_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
    volumes:
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
      - ./microservices/prepa-data/requirements.txt:/opt/prepadata/requirements.txt
    command: >
      bash -c " pip install --upgrade pip && pip install --default-timeout=1000 --retries=10 --no-cache-dir pandas numpy scikit-learn sqlalchemy psycopg2-binary && echo 'PrepData Microservice ready!' && tail -f /dev/null "

  # ==========================================
  # MOODLE & LMS CONNECTOR (Merged)
  # ==========================================
  moodleapp:
    build:
      context: ./microservices/lms-connector/moodle-docker/moodle-docker
    image: moodleapp:1.0
    ports:
      - "80:80"
    volumes:
      - moodledata:/var/www/moodledata
    depends_on:
      - moodledb

  moodledb:
    image: mysql:8.4.5
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-moodle}
      MYSQL_USER: ${MYSQL_USER:-moodle}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-moodle}
    volumes:
      - clouddbdata:/var/lib/mysql

  phpmyadmin:
    image: phpmyadmin
    restart: always
    ports:
      - "8082:80"
    environment:
      PMA_HOST: clouddb
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-moodle}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-moodle}
    depends_on:
      - moodledb

  lmsdb:
    image: postgres:15
    restart: always
    environment:
      POSTGRES_DB: lmsconnector
      POSTGRES_USER: lms
      POSTGRES_PASSWORD: lmspass
    volumes:
      - lmsdbdata:/var/lib/postgresql/data
      - ./microservices/lms-connector/moodle-docker/moodle-docker/LMSConnector/sql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5433:5432"

  lms-connector:
    build:
      context: ./microservices/lms-connector/moodle-docker/moodle-docker/LMSConnector
    image: edupath/lms-connector:latest
    depends_on:
      - moodleapp
      - lmsdb
      - rabbitmq
      - eureka-server
    environment:
      MOODLE_API_URL: http://moodleapp/webservice/rest/server.php
      MOODLE_TOKEN: 340fe84eeed17856a8bad6c59d2c87ed
      DB_HOST: lmsdb
      DB_NAME: lmsconnector
      DB_USER: lms
      DB_PASSWORD: lmspass
      EUREKA_HOST: eureka-server
      INSTANCE_HOST: lms-connector
    ports:
      - "3001:3000"

  student-profiler:
    build:
      context: ./microservices/student-profiler
      dockerfile: Dockerfile
    image: edupath/student-profiler:latest
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: profiler_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      EUREKA_SERVER: http://eureka-server:8761/eureka
      INSTANCE_HOST: student-profiler
    volumes:
      - ./microservices/student-profiler:/app
    ports:
      - "8000:8000"

  path-predictor:
    build:
      context: ./microservices/path-predictor
      dockerfile: Dockerfile
    image: edupath/path-predictor:latest
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: predictor_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      EUREKA_SERVER: http://eureka-server:8761/eureka
      INSTANCE_HOST: path-predictor
    volumes:
      - ./microservices/path-predictor:/app
    ports:
      - "8002:8002"

  reco-builder:
    build:
      context: ./microservices/reco-builder
    image: edupath/reco-builder:latest
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
      elasticsearch:
        condition: service_started
      eureka-server:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: predictor_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      ES_HOST: elasticsearch
      ES_PORT: 9200
      EUREKA_SERVER: http://eureka-server:8761/eureka
      INSTANCE_HOST: reco-builder
    ports:
      - "8003:8003"
    volumes:
      - ./microservices/reco-builder:/app

  teacher-console-api:
    build:
      context: ./microservices/teacher-console-api
      dockerfile: Dockerfile
    image: edupath/teacher-console-api:latest
    depends_on:
      postgres:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: profiler_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      EUREKA_SERVER: http://eureka-server:8761/eureka
      INSTANCE_HOST: teacher-console-api
    volumes:
      - ./microservices/teacher-console-api:/app
    ports:
      - "8004:8004"

  teacher-console:
    build:
      context: ./microservices/TeacherConsole
      dockerfile: Dockerfile
    image: edupath/teacher-console:latest
    ports:
      - "8088:80"
    depends_on:
      - teacher-console-api
      - api-gateway

  student-coach-api:
    build:
      context: ./microservices/student-coach-api
      dockerfile: Dockerfile
    image: edupath/student-coach-api:latest
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: profiler_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      EUREKA_SERVER: http://eureka-server:8761/eureka
      INSTANCE_HOST: student-coach-api
    volumes:
      - ./microservices/student-coach-api:/app
    ports:
      - "8005:8005"

volumes:
  postgres_data_new:
  es_data:
  minio_data:
  moodledata:
  clouddbdata:
  lmsdbdata:
