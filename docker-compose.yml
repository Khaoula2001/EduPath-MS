#version: '3.8'

services:
  # ==========================================
  # PostgreSQL Database - ULTRA LÉGER
  # ==========================================
#  postgres:
#    image: postgres:15-alpine
#    container_name: prepadata_postgres
#    environment:
#      POSTGRES_USER: prepadata
#      POSTGRES_PASSWORD: prepadata_pwd
#      POSTGRES_DB: analytics
#    volumes:
#      - ./microservices/prepa-data/sql:/docker-entrypoint-initdb.d:ro
#    ports:
#      - "5432:5432"
#    healthcheck:
#      test: ["CMD-SHELL", "pg_isready -U prepadata -d analytics"]
#      interval: 5s
#      timeout: 5s
#      retries: 5

  postgres:
    image: postgres:15-alpine
    container_name: prepadata_postgres
    environment:
      POSTGRES_USER: prepadata
      POSTGRES_PASSWORD: prepadata_pwd
      POSTGRES_DB: analytics
    volumes:
      - postgres_data:/var/lib/postgresql/data  # Changement important ici
      - ./sql/init-multiple-databases.sql:/docker-entrypoint-initdb.d/00-init-databases.sql:ro
      - ./microservices/prepa-data/sql:/docker-entrypoint-initdb.d/01-prepadata:ro
      - ./microservices/lms-connector/sql:/docker-entrypoint-initdb.d/02-lms:ro
    ports:
      - "5432:5432"
    restart: unless-stopped  # Ajoutez cette ligne
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U prepadata -d analytics" ]
      interval: 10s  # Augmentez l'intervalle
      timeout: 10s
      retries: 10
      start_period: 30s



  # ==========================================
  # Apache Airflow - VERSION OFFICIELLE
  # ==========================================
  airflow-init:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: airflow_init
    depends_on:
      - postgres
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: >
      bash -c "
      echo '=== UPGRADE PIP ===' &&
      pip install --upgrade pip &&
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir scikit-learn>=1.6.1 pandas numpy &&
      echo '=== ATTENTE POSTGRESQL ===' &&
      until PGPASSWORD=prepadata_pwd psql -h postgres -U prepadata -d analytics -c 'SELECT 1' >/dev/null 2>&1; do
        echo 'En attente de PostgreSQL...';
        sleep 2;
      done &&
      echo '=== INITIALISATION DB ===' &&
      airflow db init &&
      echo '=== UPGRADE DB ===' &&
      airflow db upgrade &&
      echo '=== CREATION UTILISATEUR ===' &&
      airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || echo 'Utilisateur existe déjà'
      "

  airflow-webserver:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: prepadata_airflow_webserver
    restart: unless-stopped
    depends_on:
      - postgres
      - airflow-init
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
      AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX: "True"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    ports:
      - "8081:8080"
    command: >
      bash -c "
      echo '=== UPGRADE PIP ===' &&
      pip install --upgrade pip &&
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir scikit-learn>=1.6.1 pandas numpy && 
      sleep 5 &&
      echo '=== DEMARRAGE WEBSERVER ===' &&
      airflow webserver --port 8080
      "

  airflow-scheduler:
    image: apache/airflow:2.7.3  # Version plus récente avec Python 3.8+
    container_name: prepadata_airflow_scheduler
    restart: unless-stopped
    depends_on:
      - airflow-webserver
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
      AIRFLOW__CORE__LOAD_EXAMPLES: "False"
      AIRFLOW__CORE__FERNET_KEY: "81HqDtbqAywKSOumSha3BhWNOdQ26slT6K0YaZeZyPs="
      AIRFLOW__WEBSERVER__SECRET_KEY: "46e8d8c7a3f2b1d9e5c4a6f8b2d7e9c1a3f5b8d2e7c9a4f6b1d8e3c7a9f2b5d4"
    volumes:
      - ./microservices/prepa-data/dags:/opt/airflow/dags
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
    command: >
      bash -c "
      echo '=== UPGRADE PIP ===' &&
      pip install --upgrade pip &&
      echo '=== INSTALL DEPENDENCIES ===' &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir scikit-learn>=1.6.1 pandas numpy && 
      sleep 10 &&
      echo '=== DEMARRAGE SCHEDULER ===' &&
      airflow scheduler
      "

  prepadata:
    image: python:3.10-slim
    container_name: prepadata_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: prepadata_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      AIRFLOW__CORE__SQL_ALCHEMY_CONN: postgresql://prepadata:prepadata_pwd@postgres:5432/prepadata_db
    volumes:
      - ./microservices/prepa-data/src:/opt/prepadata/src
      - ./microservices/prepa-data/data:/opt/prepadata/data
      - ./microservices/prepa-data/config:/opt/prepadata/config
      - ./microservices/prepa-data/requirements.txt:/opt/prepadata/requirements.txt
    ports:
      - "8001:8001"
    command: >
      bash -c "
      pip install --upgrade pip &&
      pip install --default-timeout=1000 --retries=10 --no-cache-dir pandas numpy scikit-learn>=1.6.1 sqlalchemy psycopg2-binary fastapi uvicorn apache-airflow &&
      echo 'PrepData Microservice ready!' &&
      python /opt/prepadata/src/api.py
      "

  lms-connector:
    build:
      context: ./microservices/lms-connector
      dockerfile: Dockerfile
    container_name: lms_connector_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: lms_db
      DB_USER: prepadata
      DB_PASSWORD: prepadata_pwd
    ports:
      - "3001:3000"

  student-profiler:
    build:
      context: ./microservices/student-profiler
      dockerfile: Dockerfile
    container_name: student_profiler_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: profiler_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
    volumes:
      - ./microservices/student-profiler:/app
    ports:
      - "8000:8000"

  path-predictor:
    build:
      context: ./microservices/path-predictor
      dockerfile: Dockerfile
    container_name: path_predictor_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: predictor_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
      MLFLOW_TRACKING_URI: http://mlflow:5000
    ports:
      - "8002:8002"

  reco-builder:
    build:
      context: ./microservices/recco-builder
    container_name: reco_builder_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: reco_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
    ports:
      - "8003:8003"

  teacher-console-api:
    build:
      context: ./microservices/teacher-console-api
      dockerfile: Dockerfile
    container_name: teacher_console_api_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: teacher_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
    ports:
      - "8004:8004"

  student-coach-api:
    build:
      context: ./microservices/student-coach-api
      dockerfile: Dockerfile
    container_name: student_coach_api_service
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PG_HOST: postgres
      PG_PORT: 5432
      PG_DB: student_db
      PG_USER: prepadata
      PG_PASSWORD: prepadata_pwd
    ports:
      - "8005:8005"

  api-gateway:
    build:
      context: ./microservices/api-gateway
      dockerfile: Dockerfile
    container_name: api_gateway
    depends_on:
      - lms-connector
      - student-profiler
      - path-predictor
      - reco-builder
      - teacher-console-api
      - student-coach-api
    ports:
      - "4000:4000"

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.7.1
    container_name: mlflow_server
    ports:
      - "5000:5000"
    command: mlflow server --host 0.0.0.0

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"

  rabbitmq:
    image: rabbitmq:3.11-management-alpine
    container_name: rabbitmq
    ports:
      - "5672:5672"  # Port for AMQP (messaging)
      - "15672:15672" # Port for web management UI
    environment:
      RABBITMQ_DEFAULT_USER: edupath
      RABBITMQ_DEFAULT_PASS: edupath
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio
    container_name: minio_server
    ports:
      - "9999:9000"    # Changed from 9000
      - "9998:9001"    # Changed from 9001
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadminpassword
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"

volumes:
    postgres_data:
    minio_data:
